<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>çµ±è¨ˆçµæœ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1224;
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.14);
      --stroke: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --primary: #6EA8FE;
      --good: #34D399;
      --bad: #FB7185;
    }
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(110,168,254,.35), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(52,211,153,.22), transparent 55%),
        radial-gradient(900px 600px at 55% 90%, rgba(236,72,153,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .glass{
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: 0 10px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.18);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    #loading{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,.55); z-index:9999;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .badge-soft{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color:var(--text);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      font-size:.9rem;
    }
    .listline{border-top:1px solid rgba(255,255,255,.12); padding-top:12px; margin-top:12px}
    .ok{color:rgba(52,211,153,.95)}
    .no{color:rgba(251,113,133,.95)}
  </style>
</head>
<body>
  <div id="loading">
    <div class="glass p-4 text-center" style="min-width:260px">
      <div class="spinner-border text-light mb-3"></div>
      <div class="muted">è¼‰å…¥ä¸­â€¦</div>
    </div>
  </div>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-xxl-10">
        <div class="glass p-4 p-md-5" id="card" style="display:none;">
          <div class="d-flex justify-content-between align-items-end flex-wrap gap-2">
            <div>
              <h1 class="h3 fw-bold mb-1" id="title"></h1>
              <div class="muted" id="range"></div>
            </div>
            <div class="pill">åƒèˆ‡è€…ï¼š<span id="pCount" class="fw-bold ms-1"></span></div>
          </div>

          <hr class="border-light opacity-25 my-4">

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="glass p-3 h-100">
                <div class="fw-bold">ğŸ‘‘ Top 3</div>
                <div id="top3" class="mt-3"></div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="glass p-3 h-100">
                <div class="fw-bold">âœ… å…¨å“¡éƒ½æœ‰ç©º</div>
                <div id="allAvail" class="mt-3 muted"></div>
              </div>
            </div>
          </div>

          <div class="glass p-3 mt-3">
            <div class="fw-bold">ğŸ‘¥ åƒèˆ‡ç‹€æ…‹</div>
            <div id="status" class="mt-2"></div>
          </div>

          <div class="mt-3 mono muted2 small" id="debug" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyP1OFWqs5B_8GUFWTm-K__jnVkwgb2TGQsusT-KZ0VnTO2snM8MDekk_1FiQ2d2l1g/exec";
  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId") || params.get("eventid");
  const loading = (on)=> document.getElementById("loading").style.display = on ? "flex" : "none";

  function safeJoin(arr){ return (arr && arr.length) ? arr.join("ã€") : "â€”"; }

  async function load(){
    if(!eventId){ loading(false); alert("ç¼ºå°‘ eventId"); return; }

    loading(true);
    try{
      const res = await fetch(`${API_URL}?action=getResults&eventId=${encodeURIComponent(eventId)}`, { redirect:"follow" });
      const data = await res.json();
      if(data.error) throw new Error(data.error);

      const ev = data.event || {};
      title.textContent = ev.title || "æœªå‘½åæ´»å‹•";
      range.textContent = `${ev.startDate || ""} ~ ${ev.endDate || ""}`;
      pCount.textContent = String(data.totalParticipants || 0);

      const pbk = data.peopleByKey || {};
      const top = Array.isArray(data.top3) ? data.top3 : [];

      top3.innerHTML = top.length ? top.map((x,i)=>{
        const yes = pbk[x.key]?.yes || [];
        const no  = pbk[x.key]?.no  || [];
        return `
          <div class="${i? "listline":""}">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="fw-bold">#${i+1} <span class="mono">${x.key}</span></div>
              <span class="badge badge-soft rounded-pill">${x.count}/${data.totalParticipants}</span>
            </div>
            <div class="muted2 small mt-2"><span class="ok fw-semibold">å¯ï¼š</span>${safeJoin(yes)}</div>
            <div class="muted2 small"><span class="no fw-semibold">ä¸å¯ï¼š</span>${safeJoin(no)}</div>
          </div>
        `;
      }).join("") : `<div class="muted">ç›®å‰æ²’æœ‰å¯çµ±è¨ˆçš„è³‡æ–™ï¼ˆå¯èƒ½éƒ½æ²’å‹¾ï¼‰</div>`;

      const allAvail = Array.isArray(data.allAvailable) ? data.allAvailable : [];
      allAvailEl.innerHTML = allAvail.length
        ? allAvail.map(k=>`<div class="mono">${k}</div>`).join("")
        : `ç›®å‰æ²’æœ‰å…¨å“¡äº¤é›†`;

      const st = Array.isArray(data.status) ? data.status : [];
      status.innerHTML = st.length ? st.map(s=>{
        return `<span class="badge me-2 mb-2 ${s.filled ? "text-bg-success":"text-bg-secondary"}">${s.nickname}${s.filled?" âœ“":"ï¼ˆæœªå¡«ï¼‰"}</span>`;
      }).join("") : `<div class="muted">å°šç„¡åƒèˆ‡è€…</div>`;

      debug.textContent = `eventId=${eventId} | totalParticipants=${data.totalParticipants}`;
      card.style.display="block";
    }catch(err){
      console.error(err);
      alert("è¼‰å…¥å¤±æ•—ï¼š" + err.message);
    }finally{
      loading(false);
    }
  }

  const allAvailEl = document.getElementById("allAvail");
  load();
</script>
</body>
</html>
