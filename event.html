<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>填寫時間</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1224;
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.14);
      --stroke: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --primary: #6EA8FE;
      --good: #34D399;
      --warn: #FBBF24;
    }
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(110,168,254,.35), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(52,211,153,.22), transparent 55%),
        radial-gradient(900px 600px at 55% 90%, rgba(236,72,153,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .glass{
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: 0 10px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.18);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}

    #loading{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,.55); z-index:9999;
    }

    .form-control{
      background: rgba(255,255,255,.08) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      color: var(--text) !important;
      border-radius: 14px;
    }
    .form-control::placeholder{color: rgba(255,255,255,.48)}
    .form-control:focus{
      box-shadow: 0 0 0 .25rem rgba(110,168,254,.20) !important;
      border-color: rgba(110,168,254,.55) !important;
    }

    .btn-glow{
      border:none;
      background: linear-gradient(135deg, rgba(110,168,254,1), rgba(99,102,241,1));
      box-shadow: 0 10px 30px rgba(110,168,254,.35);
      color:#0b1224 !important;
      font-weight:800;
    }
    .btn-glow:hover{filter:brightness(1.06)}

    .btn-success{
      background: linear-gradient(135deg, rgba(52,211,153,1), rgba(16,185,129,1)) !important;
      border:none !important;
      box-shadow: 0 10px 28px rgba(52,211,153,.28);
      color:#0b1224 !important;
      font-weight:800;
    }
    .btn-success:hover{filter:brightness(1.06)}

    .btn-outline-light{
      border-color: rgba(255,255,255,.26) !important;
      color: var(--text) !important;
    }
    .btn-outline-light:hover{
      background: rgba(255,255,255,.10) !important;
      border-color: rgba(255,255,255,.34) !important;
    }

    /* ===== iPhone 可點的格子：label 包 input（最穩） ===== */
    .cell-label{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 44px;              /* iOS 建議可點高度 */
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.72);
      color: rgba(0,0,0,.88);        /* ✅ 深色字 */
      font-weight: 700;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
    }
    .cell-label:active{transform: scale(.99)}
    .cell-label input{
      position:absolute;
      inset:0;
      opacity:0;                     /* ✅ 隱藏但保留實體（iPhone 才能點） */
      margin:0;
      width:100%;
      height:100%;
      cursor:pointer;
    }
    .cell-label.checked{
      background: rgba(52,211,153,.95);
      border-color: rgba(52,211,153,1);
      color: rgba(0,0,0,.90);        /* ✅ 勾選後也深色 */
    }

    table{color:var(--text)}
    th, td{vertical-align: middle !important;}
    .mono{font-family: ui-monospace, Menlo, Consolas, monospace;}
  </style>
</head>

<body>
  <div id="loading">
    <div class="glass p-4 text-center" style="min-width:260px">
      <div class="spinner-border text-light mb-3"></div>
      <div class="muted">載入中…</div>
    </div>
  </div>

  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-xl-10">
        <div class="glass p-4 p-md-5" id="card" style="display:none;">
          <div class="d-flex justify-content-between align-items-end flex-wrap gap-2">
            <div>
              <h1 class="h3 fw-bold mb-1" id="eventTitle"></h1>
              <div class="muted" id="eventRange"></div>
            </div>
            <a class="btn btn-outline-light rounded-pill" id="goResults" target="_blank" rel="noopener">看統計</a>
          </div>

          <hr class="border-light opacity-25 my-4">

          <!-- Step 1: 輸入暱稱 -->
          <div id="stepLogin">
            <div class="fw-semibold mb-2">你的暱稱</div>
            <input id="nicknameInput" class="form-control form-control-lg" placeholder="例如：小美">
            <button class="btn btn-glow btn-lg w-100 mt-3" id="btnStart">開始填寫</button>
            <div class="muted2 small mt-2">暱稱用來統計誰可以/誰不行。</div>
          </div>

          <!-- Step 2: 暱稱重複提示 -->
          <div id="stepConfirm" style="display:none;">
            <div class="alert alert-warning">
              <div class="fw-bold">這個暱稱已有人使用，若是你本人請繼續，否則換一個暱稱</div>
              <div class="muted2 small mt-1">（例如你之前填過、或剛好撞名）</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-light flex-fill" id="btnChangeNick">更換暱稱</button>
              <button class="btn btn-success flex-fill" id="btnUseNick">繼續使用此暱稱</button>
            </div>
          </div>

          <!-- Step 3: 勾選格子 -->
          <div id="stepFill" style="display:none;">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
              <div class="muted">填寫人：<span id="displayNick" class="fw-bold"></span></div>
              <button class="btn btn-success rounded-pill px-4" id="btnSave">儲存我的時間</button>
            </div>

            <div class="table-responsive">
              <table class="table table-borderless align-middle" style="min-width:760px;">
                <thead>
                  <tr id="thead">
                    <th class="muted">日期</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <div class="muted2 small">點格子＝可，再點一次取消。</div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyP1OFWqs5B_8GUFWTm-K__jnVkwgb2TGQsusT-KZ0VnTO2snM8MDekk_1FiQ2d2l1g/exec";
  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId") || params.get("eventid");

  const loading = (on)=> document.getElementById("loading").style.display = on ? "flex" : "none";

  let eventData = null;
  let currentNick = "";
  let nicknameNorm = "";
  let initialKeys = [];

  function toYMD(input){
    if(!input) return "";
    const s = String(input).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    if(/^\d{4}-\d{2}-\d{2}t/i.test(s)) return s.slice(0,10);
    const d = new Date(s);
    if(!isNaN(d.getTime())){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }
    return "";
  }
  function ymdToDate(ymd){
    const m = String(ymd||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return new Date("Invalid");
    return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
  }
  function dateToYMD(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  function ymdLabel(ymd){
    const parts = ymd.split("-");
    return `${parseInt(parts[1],10)}/${parseInt(parts[2],10)}`;
  }

  async function apiPost(payload){
    const res = await fetch(API_URL, {
      method: "POST",
      redirect: "follow",
      headers: { "Content-Type": "text/plain;charset=utf-8" }, // ✅ 你的 GAS 需要這個
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    return data;
  }

  async function loadEvent(){
    if(!eventId){
      loading(false);
      alert("缺少 eventId");
      return;
    }
    try{
      const res = await fetch(`${API_URL}?action=getEvent&eventId=${encodeURIComponent(eventId)}`, { redirect:"follow" });
      const data = await res.json();
      if(data.error) throw new Error(data.error);

      data.startDate = toYMD(data.startDate);
      data.endDate   = toYMD(data.endDate);
      if(!data.startDate || !data.endDate) throw new Error("活動日期解析失敗（startDate/endDate）");
      if(!Array.isArray(data.timeSlots) || !data.timeSlots.length) data.timeSlots = ["整天"];

      eventData = data;

      document.getElementById("eventTitle").textContent = eventData.title || "未命名活動";
      document.getElementById("eventRange").textContent = `${eventData.startDate} ~ ${eventData.endDate}`;

      const base = location.href.split("/").slice(0,-1).join("/");
      document.getElementById("goResults").href = `${base}/results.html?eventId=${encodeURIComponent(eventId)}`;

      document.getElementById("card").style.display = "block";
    }catch(err){
      console.error(err);
      alert("載入活動失敗：" + err.message);
    }finally{
      loading(false);
    }
  }

  function clearTable(){
    document.getElementById("thead").innerHTML = `<th class="muted">日期</th>`;
    document.getElementById("tbody").innerHTML = "";
  }

  function renderGrid(){
    clearTable();

    const slots = eventData.timeSlots;
    const thead = document.getElementById("thead");
    slots.forEach(slot=>{
      const th = document.createElement("th");
      th.className = "text-center muted";
      th.textContent = slot;
      thead.appendChild(th);
    });

    const s = ymdToDate(eventData.startDate);
    const e = ymdToDate(eventData.endDate);
    if(isNaN(s.getTime()) || isNaN(e.getTime())){
      alert("日期格式錯誤，請主揪重新建立活動");
      return;
    }

    const tbody = document.getElementById("tbody");
    let guard=0;
    for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
      guard++; if(guard>366) break;

      const ymd = dateToYMD(d);
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.innerHTML = `<div class="fw-semibold">${ymdLabel(ymd)}</div><div class="muted2 small mono">${ymd}</div>`;
      tr.appendChild(tdDate);

      slots.forEach(slot=>{
        const key = `${ymd}_${slot}`;
        const checked = initialKeys.includes(key);

        const td = document.createElement("td");
        td.className = "text-center";

        // ✅ label 包住 input（iPhone 最穩），而且字是深色
        td.innerHTML = `
          <label class="cell-label ${checked ? "checked" : ""}">
            <input type="checkbox" value="${key}" ${checked ? "checked" : ""}>
            可
          </label>
        `;

        // 讓背景跟勾選同步（不靠 :checked，iOS 也穩）
        const input = td.querySelector("input");
        const label = td.querySelector("label");
        input.addEventListener("change", ()=> {
          label.classList.toggle("checked", input.checked);
        });

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    }
  }

  async function checkNickname(){
    const nick = document.getElementById("nicknameInput").value.trim();
    if(!nick) return alert("請輸入暱稱");

    loading(true);
    try{
      const data = await apiPost({ action:"joinOrCheckNickname", eventId, nickname: nick });
      if(data.error) throw new Error(data.error);

      currentNick = nick;
      nicknameNorm = data.nicknameNorm || "";
      initialKeys = Array.isArray(data.availableKeys) ? data.availableKeys : [];

      document.getElementById("stepLogin").style.display = "none";

      if(data.exists){
        document.getElementById("stepConfirm").style.display = "block";
      }else{
        proceedToFill();
      }
    }catch(err){
      console.error(err);
      alert("暱稱檢查失敗：" + err.message);
    }finally{
      loading(false);
    }
  }

  function proceedToFill(){
    document.getElementById("stepConfirm").style.display = "none";
    document.getElementById("stepFill").style.display = "block";
    document.getElementById("displayNick").textContent = currentNick;
    renderGrid();
  }

  async function saveAvailability(){
    const selected = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(x=>x.value);

    loading(true);
    try{
      const data = await apiPost({
        action: "saveAvailability",
        eventId,
        nicknameNorm,
        availableKeys: selected
      });
      if(data.error) throw new Error(data.error);

      alert("已儲存！");
      // 存完自動去統計
      const base = location.href.split("/").slice(0,-1).join("/");
      location.href = `${base}/results.html?eventId=${encodeURIComponent(eventId)}`;
    }catch(err){
      console.error(err);
      alert("儲存失敗：" + err.message);
    }finally{
      loading(false);
    }
  }

  // 綁定按鈕
  document.getElementById("btnStart").addEventListener("click", checkNickname);
  document.getElementById("btnChangeNick").addEventListener("click", ()=>{
    document.getElementById("stepConfirm").style.display="none";
    document.getElementById("stepLogin").style.display="block";
  });
  document.getElementById("btnUseNick").addEventListener("click", proceedToFill);
  document.getElementById("btnSave").addEventListener("click", saveAvailability);

  // 啟動
  loadEvent();
</script>
</body>
</html>
